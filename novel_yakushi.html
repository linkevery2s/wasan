<!DOCTYPE html>
<html lang="ja">

<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
    <meta charset="UTF-8" name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <title>浮世の間</title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <!-- font awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"
        integrity="sha512-GWzVrcGlo0TxTRvz9ttioyYJ+Wwk9Ck0G81D+eO63BaqHaJ3YZX9wuqjwgfcV/MrB2PhaVX9DkYVhbFpStnqpQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Katex -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
        integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">

    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
        integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8"
        crossorigin="anonymous"></script>

    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
        integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05"
        crossorigin="anonymous"></script>

    <!-- $などで囲うために必要 -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            renderMathInElement(document.body, {
                delimiters: [
                    { left: "\\[", right: "\\]", display: true },
                    { left: "$", right: "$", display: false }
                ]
            });
        });
    </script>

    <!-- novel ui 共通 -->
    <link rel="stylesheet" href="./css/novel.css">

    <style>
        #game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 20px;
            box-sizing: border-box;
            background: url('./images/rpg/bg_yakushi.jpg') no-repeat center center;
            background-size: cover;
        }

        #explanation {
            display: none;
            background: #ffffff;
            padding: 1rem;
            background-image: url("./images/background/2.jpg");
            background-repeat: repeat-y;
            background-position: right;
            background-size: 25%;
            max-width: 800px;
            text-align: left;
        }
    </style>
</head>

<body>
    <div id="game-container">
        <img id="character" src="" alt="画像" style="display: none;">
        <div id="text-box">
            <div id="story-text"></div>
            <div id="choices">
                <div class="choice-button" id="next">・解説に進む ▶︎</div>
                <div class="choice-button" id="reload">・もう一度、話を聞く ▶︎</div>
                <div class="choice-button" id="map_back">・マップに戻る ▶︎</div>
            </div>
        </div>

        <div class="attribution">
        </div>

        <div class="div_right" id="skip">
            <span class="skip">Skip</span>
        </div>

    </div>

    <center>
        <div id="explanation" class="p-5">

            <div class="item_title">
                <img src="./images/icon/kokyo.svg" id="img_midashi" alt="kokyoのアイコン"> 薬師算
            </div>

            <div class="grid">
                <div class="grid-inline">
                    <a href="./data/yakushi1.jpg" data-lightbox="yakushi" data-title="薬師算"><img
                            src="./data/yakushi1.jpg" alt="薬師算" width="100%"></a>
                </div>
                <div class="grid-inline">
                    <a href="./data/yakushi2.jpg" data-lightbox="yakushi" data-title="現代語訳"><img
                            src="./data/yakushi2.jpg" alt="薬師算" width="100%"></a>
                </div>
            </div>

            <div id="literature">
                『新編塵劫記 3巻』吉田光由 著, 国立国会図書館デジタルコレクション , インターネット公開（保護期間満了）
            </div>

            <div>

                <h3> 模範回答</h3>
                <p>$4 × 4 = 16$個あり、下の碁石は必ず$12$個になるので、$16 + 12 = 28$個となる。</p>

                <h3 class="text-xl my-5" id="manual_h3">一次方程式による回答</h3>

                <p>この問題は、１辺が8個とあるが、この数は無くても正答が可能である。</p>
                <p class="my-3">１辺を$x$個あるとする。全体の個数は、$4(x - 1)$個とあろことになる。</p>
                <p class="my-3">並び替えると、$(3x + 4)$個あることが分かるので、</p>
                <p class="my-3">$4(x - 1) = 3x + 4$</p>
                <p class="my-3">これを解いて、$x = 8$</p>
                <p class="my-3">よって全体の個数は、$4(8 - 1) = 28$個と求められる。</p>

                <p>答え：$28$ 個</p>

            </div>

            <div class="div_right" id="story_back">
                <span class="top"><i class="fa-solid fa-angles-up"></i> TOP</span>
                <span class="story_back" onclick="location.reload();">Story Back</span>
            </div>

        </div>
    </center>

    <script type="module">
        const story = [
            {
                text: "[あなた]...ここは、どこだろう？工房みたいだけど...",
                character: null
            },
            {
                text: "[？？？]おや、珍しい客人だね。こんな工房に迷い込むとは、運が良いのか悪いのか。",
                character: "./images/rpg/set_moronobu.jpg"
            },
            {
                text: "[菱川師宣]私は菱川師宣。浮世絵の元祖なんて呼ばれているよ。もっとも、そんな大層な名は、後の人が勝手につけたものだけどね。",
                character: "./images/rpg/set_moronobu.jpg"
            },
            {
                text: "[あなた]えっ...！菱川師宣！？『見返り美人図』で有名な、あの...？",
                character: "./images/rpg/set_moronobu.jpg"
            },
            {
                text: "[菱川師宣]そう、その“あの”だよ。まあ、私の絵なんて、見た人が楽しんでくれればそれでいいのさ。",
                character: "./images/rpg/set_moronobu.jpg"
            },
            {
                text: "[人物紹介]菱川師宣（生没年不詳・17世紀）。江戸初期の浮世絵師で、墨摺絵・彩色画などを手がけ、後に大流行する浮世絵文化の礎を築いた人物。",
                character: "./images/rpg/set_moronobu.jpg"
            },
            {
                text: "[人物紹介]代表作『見返り美人図』は、優美な女性表現として日本絵画史に名を残す。",
                character: "./images/rpg/set_moronobu.jpg"
            },
            {
                text: "[菱川師宣]さて、ただの見学に来たわけじゃないんだろう？私の工房に来る者は必ず「観察」が試される。",
                character: "./images/rpg/set_moronobu.jpg"
            },
            {
                text: "[菱川師宣]和算も絵も、まずは物事の構造をよく見ることから始まるからね。",
                character: "./images/rpg/set_moronobu.jpg"
            },
            {
                text: "[あなた]和算の問題...出してくれるんですか？",
                character: "./images/rpg/set_moronobu.jpg"
            },
            {
                text: "[菱川師宣]もちろんだとも。では、出題するよ。",
                character: "./images/rpg/set_moronobu.jpg"
            },
            {
                text: "[問題]碁石を四方に８個ずつ並べます。今、４辺のうち３辺をくずして左に８個ずつ並べると、左端に４個ありました。碁石の個数を答えてください。",
                character: null
            },
            {
                text: "[あなた]この問題は、薬師算だ！",
                character: null
            },
            {
                text: "[あなた]よしっ、解いてみよう！",
                character: null
            },
        ];

        let currentIndex = 0;
        const storyText = document.getElementById("story-text");
        const textbox = document.getElementById("text-box");
        const characterImg = document.getElementById("character");
        const choicesDiv = document.getElementById("choices");

        let isTyping = false;

        let indicator;

        let typeText = (text, callback) => {
            let i = 0;
            storyText.textContent = "";
            isTyping = true;
            // nextButton.disabled = true;
            textbox.disabled = true;

            if (indicator) {
                indicator.remove();
                indicator = null;
            }

            const interval = setInterval(() => {
                storyText.textContent += text.charAt(i);
                i++;
                if (i >= text.length) {
                    clearInterval(interval);
                    isTyping = false;
                    textbox.disabled = false;

                    showIndicator();

                    if (callback) callback();
                }
            }, 50); // 表示間隔（ミリ秒）
        }

        let showIndicator = () => {
            indicator = document.createElement("span");
            indicator.id = "next-indicator";
            indicator.textContent = "▶︎";
            storyText.appendChild(indicator);
        }

        let showNext = () => {

            if (currentIndex < story.length) {
                const { text, character } = story[currentIndex];

                // キャラクター表示/非表示
                if (character) {
                    characterImg.src = character;
                    characterImg.style.display = "block";
                } else {
                    characterImg.style.display = "none";
                }

                typeText(text);
                currentIndex++;

            } else {

                /* 選択肢メニュー表示 */
                storyText.style.display = "none";
                choicesDiv.style.display = "block";
                textbox.disabled = false;

            }
        }

        textbox.addEventListener("click", () => {
            if (!isTyping) {
                showNext();
            }
        });

        /* 選択ボタン */
        const next = document.querySelector("#next");
        const reload = document.querySelector("#reload");
        const map_back = document.querySelector("#map_back");

        next.addEventListener("click", () => {

            document.querySelector("#game-container").style.display = "none";
            $('#explanation').fadeIn();

        });

        reload.addEventListener("click", () => {

            location.reload();

        });

        map_back.addEventListener("click", () => {

            textbox.textContent = "左下のMENUからホームボタンをタップして、ダンジョンマップにお戻りください。";

        });

        // 最初のストーリー表示
        showNext();

        const top_back = document.querySelector(".top");

        top_back.addEventListener("click", () => {

            $('body,html').animate({
                scrollTop: $("#explanation").offset().top
            }, 1000);

            return false;

        });


        /* スキップボタン */
        const skip = document.querySelector(".skip");

        skip.addEventListener("click", () => {

            document.querySelector("#game-container").style.display = "none";
            $('#explanation').fadeIn();

        });

    </script>

    <!-- lightbox2 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox.min.js"
        integrity="sha512-Ixzuzfxv1EqafeQlTCufWfaC6ful6WFqIz4G+dWvK0beHw0NVJwvCKSgafpy5gwNqKmgUfIBraVwkKI+Cz0SEQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/css/lightbox.min.css"
        integrity="sha512-ZKX+BvQihRJPA8CROKBhDNvoc2aDMOdAlcm7TUQY+35XYtrd3yh95QOOhsPDQY9QnKE0Wqag9y38OIgEvb88cA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- lightbox2 options -->
    <script>
        lightbox.option({
            "alwaysShowNavOnTouchDevices": true,
            "disableScrolling": true
        })

    </script>

</body>

</html>